name: CI

on:
  push:
    branches:
      - master
  pull_request:

permissions:
  actions: read
  contents: read
  pull-requests: write

jobs:
  main:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: test_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4
        with:
          filter: tree:0
          fetch-depth: 0

      # This enables task distribution via Nx Cloud
      # Run this command as early as possible, before dependencies are installed
      # Learn more at https://nx.dev/ci/reference/nx-cloud-cli#npx-nxcloud-startcirun
      # Uncomment this line to enable task distribution
      # - run: npx nx start-ci-run --distribute-on="3 linux-medium-js" --stop-agents-after="build"

      # Cache node_modules
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - run: npm ci

      # Run lint
      - name: Lint
        run: npx nx run-many -t lint

      # Run typecheck
      - name: Type Check
        run: npx nx run-many -t typecheck

      # Run unit tests with coverage
      - name: Unit Tests
        run: npx nx run-many -t test --coverage --coverageReporters=lcov,text-summary
        env:
          CI: true

      # Run build
      - name: Build
        run: npx nx run-many -t build

      # Upload coverage reports
      - name: Upload Coverage
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage/**/lcov.info
          fail_ci_if_error: false
          verbose: true
        if: always()

      # Nx Cloud recommends fixes for failures to help you get CI green faster
      - run: npx nx fix-ci
        if: always()

  # Docker build job (runs on master only)
  docker:
    runs-on: ubuntu-latest
    needs: main
    if: github.ref == 'refs/heads/master' && github.event_name == 'push'

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build API Server Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/Dockerfile.api
          push: false
          tags: blog-api:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Integration tests job (optional - can be enabled when ready)
  integration-tests:
    runs-on: ubuntu-latest
    needs: main
    if: github.event_name == 'pull_request'

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: test_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - run: npm ci

      # Run database migrations
      - name: Run Migrations
        run: |
          PGPASSWORD=test psql -h localhost -U test -d test_db -f database/migrations/001_initial_schema.sql || true
          PGPASSWORD=test psql -h localhost -U test -d test_db -f database/migrations/002_security_tokens.sql || true
          PGPASSWORD=test psql -h localhost -U test -d test_db -f database/migrations/003_follows.sql || true
        env:
          PGHOST: localhost
          PGPORT: 5432

      # Run integration tests
      - name: Integration Tests
        run: npx nx run @blog/backend/infrastructure:test --testPathPattern="api\\.spec"
        env:
          DATABASE_HOST: localhost
          DATABASE_PORT: 5432
          DATABASE_NAME: test_db
          DATABASE_USER: test
          DATABASE_PASSWORD: test
          REDIS_HOST: localhost
          REDIS_PORT: 6379
          NODE_ENV: test
